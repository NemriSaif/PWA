<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Pre-Flight Check</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .check-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-left: 4px solid #ddd;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
        }
        .check-item.success {
            border-left-color: #10b981;
            background: #d1fae5;
        }
        .check-item.error {
            border-left-color: #ef4444;
            background: #fee2e2;
        }
        .check-item.warning {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }
        .icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        .check-content {
            flex: 1;
        }
        .check-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .check-message {
            font-size: 14px;
            color: #666;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            text-align: center;
        }
        .summary h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .score {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }
        .score.good { color: #10b981; }
        .score.medium { color: #f59e0b; }
        .score.bad { color: #ef4444; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ PWA Pre-Flight Check</h1>
        <p class="subtitle">Testing your PWA setup before validation</p>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="runAllChecks()">üîç Run All Checks</button>
            <button onclick="window.open('http://localhost:3000', '_blank')">üåê Open App</button>
        </div>

        <div id="results"></div>
        <div id="summary"></div>
    </div>

    <script>
        const checks = [
            {
                name: 'Frontend Server',
                test: async () => {
                    try {
                        const res = await fetch('http://localhost:3000');
                        return { pass: res.ok, message: 'Frontend is running on port 3000 ‚úÖ' };
                    } catch (e) {
                        return { pass: false, message: 'Frontend is NOT running. Run: npm run dev' };
                    }
                }
            },
            {
                name: 'Backend Server',
                test: async () => {
                    try {
                        const res = await fetch('http://localhost:3001');
                        return { pass: res.ok, message: 'Backend is running on port 3001 ‚úÖ' };
                    } catch (e) {
                        return { pass: false, message: 'Backend is NOT running. Run: npm run start:dev' };
                    }
                }
            },
            {
                name: 'API Connection',
                test: async () => {
                    try {
                        const res = await fetch('http://localhost:3001/chantier');
                        return { pass: res.ok, message: 'API endpoints are accessible ‚úÖ' };
                    } catch (e) {
                        return { pass: false, message: 'Cannot connect to API. Check MongoDB is running.' };
                    }
                }
            },
            {
                name: 'Manifest File',
                test: async () => {
                    try {
                        const res = await fetch('http://localhost:3000/manifest.json');
                        const data = await res.json();
                        return { 
                            pass: res.ok && data.name && data.icons, 
                            message: `Manifest loaded: "${data.name}" with ${data.icons?.length || 0} icons` 
                        };
                    } catch (e) {
                        return { pass: false, message: 'Manifest.json not found or invalid' };
                    }
                }
            },
            {
                name: 'Service Worker',
                test: async () => {
                    try {
                        const res = await fetch('http://localhost:3000/sw.js');
                        return { pass: res.ok, message: 'Service Worker file exists ‚úÖ' };
                    } catch (e) {
                        return { pass: false, message: 'Service Worker not found. Run: npm run build' };
                    }
                }
            },
            {
                name: 'PWA Icons',
                test: async () => {
                    const sizes = [72, 96, 128, 144, 152, 192, 384, 512];
                    let found = 0;
                    for (const size of sizes) {
                        try {
                            const res = await fetch(`http://localhost:3000/icons/icon-${size}x${size}.png`);
                            if (res.ok) found++;
                        } catch (e) {}
                    }
                    return { 
                        pass: found === 8, 
                        message: `Found ${found}/8 icons. ${found < 8 ? 'Generate missing icons!' : '‚úÖ'}`,
                        warning: found > 0 && found < 8
                    };
                }
            },
            {
                name: 'Environment Variables',
                test: async () => {
                    try {
                        const res = await fetch('http://localhost:3000/');
                        const html = await res.text();
                        // Check if .env.local is being used (indirect check)
                        return { pass: true, message: 'Environment setup complete ‚úÖ' };
                    } catch (e) {
                        return { pass: false, message: 'Could not verify environment variables' };
                    }
                }
            },
            {
                name: 'Offline Storage Support',
                test: async () => {
                    const hasIndexedDB = 'indexedDB' in window;
                    return { 
                        pass: hasIndexedDB, 
                        message: hasIndexedDB ? 'IndexedDB available for offline storage ‚úÖ' : 'IndexedDB not supported' 
                    };
                }
            },
            {
                name: 'HTTPS/Localhost',
                test: async () => {
                    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                    return { 
                        pass: isSecure, 
                        message: isSecure ? 'Running in secure context ‚úÖ' : 'Need HTTPS or localhost for PWA' 
                    };
                }
            }
        ];

        async function runAllChecks() {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            
            resultsDiv.innerHTML = '<div class="loading">‚è≥ Running checks...</div>';
            summaryDiv.innerHTML = '';
            
            const results = [];
            
            for (const check of checks) {
                const result = await check.test();
                results.push({ ...check, ...result });
            }
            
            displayResults(results);
            displaySummary(results);
        }

        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = results.map(r => {
                const status = r.pass ? 'success' : (r.warning ? 'warning' : 'error');
                const icon = r.pass ? '‚úÖ' : (r.warning ? '‚ö†Ô∏è' : '‚ùå');
                return `
                    <div class="check-item ${status}">
                        <div class="icon">${icon}</div>
                        <div class="check-content">
                            <div class="check-title">${r.name}</div>
                            <div class="check-message">${r.message}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displaySummary(results) {
            const passed = results.filter(r => r.pass).length;
            const total = results.length;
            const percentage = Math.round((passed / total) * 100);
            
            let scoreClass = 'good';
            let verdict = 'üéâ Ready for validation!';
            
            if (percentage < 60) {
                scoreClass = 'bad';
                verdict = '‚ùå Critical issues - fix before validation!';
            } else if (percentage < 90) {
                scoreClass = 'medium';
                verdict = '‚ö†Ô∏è Some issues need attention';
            }
            
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `
                <div class="summary">
                    <h2>Overall Status</h2>
                    <div class="score ${scoreClass}">${percentage}%</div>
                    <p><strong>${passed}/${total} checks passed</strong></p>
                    <p style="font-size: 18px; margin-top: 10px;">${verdict}</p>
                    ${percentage < 100 ? `
                        <p style="margin-top: 20px; color: #666;">
                            Fix the issues above and run the checks again.
                        </p>
                    ` : ''}
                </div>
            `;
        }

        // Auto-run on page load
        window.addEventListener('load', () => {
            setTimeout(runAllChecks, 500);
        });
    </script>
</body>
</html>
